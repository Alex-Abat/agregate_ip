# Программа для агрегации IP-адресов


## Исходная задача
Ресурсы МТС (включая основной сайт mts.ru) периодически подвергаются DDoS-атакам. Для того, чтобы легитимные пользователи не теряли доступ к сайту во время атак, требуется заранее подготовить «белый список» подсетей IPv4.

Вам выдается исходный список логов с IPv4-адресами, полученный в результате сбора статистики взаимодействия пользователей с веб-сервером в период, когда DDoS-атак не проводилось. Ваша задача — преобразовать его при помощи скрипта агрегации (рекомендуется использовать Python) в список подсетей, не превышающий 64 000 уникальных записей (т.к. уникальных IP-адресов миллионы, а у списка доступа есть соответствующий лимит), где каждая запись — это подсеть с любой маской подсети. В дальнейшем при обнаружении атаки на маршрутизаторе будет активироваться подготовленный вами список, по которому будет допускаться к сайту только трафик от описанных в нем подсетей.

## Описание программы

Программа обрабатывает лог-файл, извлекает IPv4‑адреса, агрегирует их в CIDR‑подсети, оптимизирует и записывает итоговый список в файл.

Программа выполняет следующие шаги:

1. Читает IP-адреса из входного файла.
2. Преобразует их в числовой формат для удобной обработки.
3. Агрегирует IP-адреса в подсети с минимальным количеством диапазонов.
4. Оптимизирует список
5. Записывает результат в выходной файл.

---

## Основные функции

### `ip_to_int(ipstr: str) -> int`
Преобразует IP-адрес из строки в целое число.  
Пример: `"192.168.1.1"` → `3232235777`  

### `int_to_ip(i: int) -> str`
Преобразует IP-адрес из целого числа обратно в строку формата CIDR.  
Пример: `3232235777` → `"192.168.1.0/24"` (при использовании в контексте подсети)

### `read_ip_list() -> list`
Считывает IP-адреса из входного файла `ip_list.txt` и возвращает их в виде отсортированного списка целых чисел.  
- Использует регулярное выражение для поиска IP в каждой строке.
- Убирает дубликаты автоматически.
- Показывает прогресс чтения и количество уникальных IP.

### `agregation_ips(ip_list: list[int], gap_threshold=2600, max_round_k=21) -> list`
**Главная функция программы — агрегация IP-адресов в подсети.**

**Как работает:**
1. Определяет диапазоны последовательных IP-адресов, где разрыв между адресами не превышает `gap_threshold`.
2. Для каждого диапазона подбирает «k» — параметр округления границ диапазона. Чем больше диапазон, тем больше можно округлить.
3. Преобразует диапазоны в сети формата `IPv4Network` с помощью `ipaddress.summarize_address_range`.
4. Выполняет слияние подсетей для минимизации их количества (две фазы).
5. Возвращает список агрегированных подсетей.

**Параметры:**
- `ip_list` — список IP-адресов в виде целых чисел.
- `gap_threshold` — максимальный разрыв между IP-адресами для объединения в один диапазон.
- `max_round_k` — максимальная степень округления границ диапазона.

### `write_subnets(ip_list: list[ipaddress.IPv4Network])`
Записывает агрегированные подсети в файл `subnets.txt`.  
- Каждая подсеть записывается в отдельной строке.
- В конце выводится статистика: количество подсетей и время обработки.

---

## Инструкция по использованию


2. Убедитесь, что в программе указан правильный путь к файлам:
   ```python
   IN_FILE = './ip_list.txt'
   OUTPUT_FILE = './subnets.txt'
   ```

3. Запустите программу:
   ```bash
   python your_script.py
   ```

4. После завершения работы программы в консоли будет выведена статистика:
   - Количество прочитанных строк и уникальных IP.
   - Количество найденных диапазонов.
   - Количество подсетей после агрегации.
   - Время обработки.

5. Результат сохранится в файле `subnets.txt` — каждая подсеть на отдельной строке.

---

## Примечания

- Для нахождения IPv4 адреса используется регулярное выражение
- Программа автоматически сортирует и удаляет дублирующиеся IP-адреса.
- Параметр `gap_threshold` можно менять для более агрессивной или более консервативной агрегации.
- Двойная фаза слияния подсетей минимизирует количество записанных подсетей без потери охвата всех IP.
